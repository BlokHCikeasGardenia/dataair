<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Live Table Google Sheets (Filter Pelanggan)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .table-container {
      max-width: 100vw;
      overflow-x: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      margin: 1.5rem auto;
      padding: 1rem;
    }
    .controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .controls input[type="search"] {
      padding: 0.5em 1em;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #c8c8c8;
      flex: 1 1 160px;
      min-width: 0;
      background: #fafbfc;
      box-sizing: border-box;
    }
    .controls label, .controls select {
      font-size: 1em;
    }
    .controls select {
      padding: 0.5em 1em;
      border-radius: 4px;
      border: 1px solid #c8c8c8;
      background: #fafbfc;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 1em;
      background: #fff;
      min-width: 600px;
    }
    thead th {
      position: sticky;
      top: 0;
      z-index: 3;
      background: #ffffffee;
      border-bottom: 2px solid #bdbdbd;
      font-weight: 600;
      text-align: left;
      color: #444;
      padding: 0.7em 0.8em;
      transition: background 0.2s;
    }
    /* Sticky columns */
    th.sticky-col, td.sticky-col {
      position: sticky;
      left: 0;
      z-index: 2;
      background: #ffffff;
      border-right: 1px solid #bdbdbd;
      min-width: 110px;
      max-width: 220px;
      text-align: left !important;
    }
    th.sticky-col-2, td.sticky-col-2 {
      position: sticky;
      left: var(--sticky-left-2, 120px);
      z-index: 2;
      background: #fff;
      border-right: 1px solid #bdbdbd;
      width: 90px !important;
      min-width: 90px !important;
      max-width: 90px !important;
      text-align: left !important;
    }
    tbody td {
      padding: 0.65em 0.9em;
      border-bottom: 1px solid #ececec;
      border-right: 1px solid #ececec;
      font-size: 1em;
      background: #fff;
      max-width: 220px;
      word-break: break-word;
    }
    tbody tr:nth-child(even) td {
      background: #f6f8fa;
    }
    tbody td:not(.sticky-col):not(.sticky-col-2) {
      text-align: right;
    }
    tbody td.sticky-col, tbody td.sticky-col-2 {
      background: #fff;
      font-weight: 500;
    }
    tr:last-child td {
      border-bottom: 2px solid #bdbdbd;
    }
    /* Responsive */
    @media (max-width: 700px) {
      table { font-size: 0.95em; }
      .table-container { padding: 0.3rem; }
      .controls { gap: 0.5rem; }
    }
    @media (max-width: 480px) {
      table { font-size: 0.87em; }
      .controls input[type="search"], .controls select {
        font-size: 0.98em;
        padding: 0.4em 0.7em;
      }
    }
    /* Pagination */
    .pagination {
      display: flex;
      gap: 0.5em;
      align-items: center;
      margin: 1em 0 0.2em 0;
      flex-wrap: wrap;
      font-size: 1em;
    }
    .pagination button {
      border: none;
      background: #f1f3f5;
      color: #444;
      padding: 0.4em 0.9em;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
      min-width: 34px;
    }
    .pagination button.active, .pagination button:focus {
      background: #2b7cff;
      color: #fff;
      outline: none;
      font-weight: 600;
    }
    .pagination button[disabled] {
      background: #ececec;
      color: #aaa;
      cursor: default;
    }
    .pagination-summary {
      margin-left: auto;
      color: #888;
      font-size: 0.96em;
    }
    /* Custom scrollbar */
    ::-webkit-scrollbar { height: 8px; background: #eaeaea;}
    ::-webkit-scrollbar-thumb { background: #d0d0d0; border-radius: 6px;}
  </style>
</head>
<body>
  <div class="table-container">
    <div class="controls">
      <input type="search" id="searchInput" placeholder="Cari data..." autocomplete="off">
      <label for="rowsPerPage">Baris/halaman:</label>
      <select id="rowsPerPage">
        <option value="10" selected>10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
    </div>
    <div style="overflow-x:auto;">
      <table id="liveTable"><thead></thead><tbody></tbody></table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>
  <script>
    // Link CSV Google Sheets
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRQBSWp7dBKus6wO8G-vBtSW9ZpKlRbmNLbXsaWQZeaQU_ZEY9p9EujIGTyIPVzb5cgVTlq9d0Lf29P/pub?gid=914322979&single=true&output=csv';

    // State
    let allData = [], filteredData = [], header = [];
    let currentPage = 1, rowsPerPage = 10, searchTerm = "";

    // Fetch CSV
    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      return parseCSV(text);
    }

    // CSV to array
    function parseCSV(str) {
      // Support quoted values with commas inside
      const rows = [];
      let row = [], val = '', inQuotes = false;
      for (let i = 0, c; i < str.length; ++i) {
        c = str[i];
        if (c === '"') {
          if (inQuotes && str[i+1] === '"') { val += '"'; ++i; }
          else inQuotes = !inQuotes;
        } else if (c === ',' && !inQuotes) { row.push(val); val = ''; }
        else if ((c === '\n' || c === '\r') && !inQuotes) {
          if (val !== '' || row.length>0) { row.push(val); rows.push(row); }
          val = ''; row = [];
          if (c === '\r' && str[i+1] === '\n') ++i;
        } else val += c;
      }
      if (val !== '' || row.length>0) { row.push(val); rows.push(row); }
      return rows.filter(r => r.length && !(r.length===1 && r[0]===""));
    }

    // Render Table
    function renderTable() {
      const table = document.getElementById('liveTable');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      // Header
      let ths = '';
      header.forEach((h, i) => {
        let cls = '';
        if (i===0) cls = 'sticky-col';
        else if (i===1) cls = 'sticky-col-2';
        ths += `<th class="${cls}">${h}</th>`;
      });
      thead.innerHTML = `<tr>${ths}</tr>`;

      // Data
      const startIdx = (currentPage - 1) * rowsPerPage;
      const dataPage = filteredData.slice(startIdx, startIdx + rowsPerPage);
      let trs = '';
      dataPage.forEach(row => {
        trs += '<tr>';
        row.forEach((cell, i) => {
          let cls = '';
          if (i===0) cls = 'sticky-col';
          else if (i===1) cls = 'sticky-col-2';
          trs += `<td class="${cls}">${cell}</td>`;
        });
        trs += '</tr>';
      });
      tbody.innerHTML = trs;

      // Adjust sticky left for col-2
      setTimeout(() => {
        const th0 = table.querySelector('th.sticky-col');
        const left = th0 ? (th0.offsetWidth || 120) : 120;
        document.querySelectorAll('.sticky-col-2').forEach(e => e.style.setProperty('--sticky-left-2', left+'px'));
      }, 50);

      renderPagination();
    }

    // Search
    function filterData() {
      if (!searchTerm.trim()) {
        filteredData = allData.slice();
      } else {
        const term = searchTerm.toLowerCase();
        filteredData = allData.filter(row =>
          row.some(cell => (cell+'').toLowerCase().includes(term))
        );
      }
      // Reset to page 1 if filter triggers
      currentPage = 1;
    }

    // Pagination
    function renderPagination() {
      const pageDiv = document.getElementById('pagination');
      const totalRows = filteredData.length;
      const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;
      let html = '';

      function pageBtn(p, txt = null, disabled = false) {
        return `<button type="button" ${disabled?'disabled':''} class="${currentPage===p?'active':''}" onclick="goToPage(${p})">${txt||p}</button>`;
      }
      html += pageBtn(1, '«', currentPage===1);
      for (let p = Math.max(1, currentPage-2); p <= Math.min(totalPages, currentPage+2); ++p)
        html += pageBtn(p, null, false);
      html += pageBtn(totalPages, '»', currentPage===totalPages);

      html += `<span class="pagination-summary">Menampilkan ${Math.min((currentPage-1)*rowsPerPage+1,totalRows)}-${Math.min(currentPage*rowsPerPage,totalRows)} dari ${totalRows} baris</span>`;
      pageDiv.innerHTML = html;
    }
    window.goToPage = function(p) {
      currentPage = p;
      renderTable();
    };

    // Handle Controls
    document.getElementById('searchInput').addEventListener('input', e => {
      searchTerm = e.target.value;
      filterData();
      renderTable();
    });
    document.getElementById('rowsPerPage').addEventListener('change', e => {
      rowsPerPage = parseInt(e.target.value, 10);
      currentPage = 1;
      renderTable();
    });

    // Initial Load
    (async function() {
      try {
        const rows = await fetchCSV(CSV_URL);
        if (!rows.length) throw new Error('Data kosong');
        header = rows[0];
        // FILTER: hanya data yang kolom ke-3 mengandung "PELANGGAN"
        allData = rows.slice(1).filter(row => (row[2] || '').toUpperCase().includes('PELANGGAN'));
        filterData();
        renderTable();
      } catch (e) {
        document.getElementById('liveTable').outerHTML = '<div style="color:red;padding:1em;">Gagal memuat data: '+e.message+'</div>';
      }
    })();
  </script>
</body>
</html>
